#!/usr/bin/env bash

set -e

[ -z "$DEBUG" ] || set -x

export BOSH_ENVIRONMENT="${1:-https://192.168.50.6:25555}"
export BOSH_NON_INTERACTIVE=false
export BOSH_CLIENT=admin
export BOSH_CLIENT_SECRET=admin
export BOSH_DEPLOYMENT=cf-rabbitmq
export BOSH_CA_CERT
BOSH_CA_CERT="$(boshgo int ~/deployments/vbox/creds.yml --path /director_ssl/ca)"

main() {
  local manifest
  manifest=$(./scripts/interpolate-manifest-for-bosh-lite)

  upload_stemcell "$manifest"
  download_blobs
  create_dev_release && upload_dev_release
  deploy "$manifest"
}

upload_stemcell() {
  local manifest="$1"
  BOSH_LITE_STEMCELL_NAME="bosh-warden-boshlite-ubuntu-trusty-go_agent"
  BOSH_LITE_STEMCELL_VERSION="$(yq .stemcells[0].version "$manifest")"
  BOSH_LITE_STEMCELL_URL="https://bosh.io/d/stemcells/$BOSH_LITE_STEMCELL_NAME?v=$BOSH_LITE_STEMCELL_VERSION"

  bosh upload-stemcell "$BOSH_LITE_STEMCELL_URL" --name "$BOSH_LITE_STEMCELL_NAME" --version "$BOSH_LITE_STEMCELL_VERSION"
}


download_blobs() {
  bosh reset-release
  bosh sync-blobs
}

create_dev_release() {
  bosh create-release --force
}

upload_dev_release() {
  bosh upload-release
}

deploy() {
  local manifest="$1"
  bosh deploy --no-redact "$manifest"
}

main
