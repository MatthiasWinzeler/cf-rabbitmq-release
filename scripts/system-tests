#!/bin/bash -ex

export BOSH_USER
BOSH_USER="${BOSH_USERNAME:?env required}"
BOSH_TARGET="${BOSH_TARGET:?env required}"
BOSH_MANIFEST="${BOSH_MANIFEST:?env required}"
DEPLOYMENT_NAME="$(awk -F ': ' '/^name/ { print $2 }' < "$BOSH_MANIFEST")"
DEPLOYMENT_NAME="${DEPLOYMENT_NAME:?failed to find deployment name in manifest}"

main() {
  install_dependencies
  run_unit_tests
  run_system_tests_individually_to_isolate_state
  delete_bosh_deployment_to_remove_state
}

install_dependencies() {
  bundle install
}

run_unit_tests() {
  bundle exec rake spec:unit
}


run_system_tests_individually_to_isolate_state() {
  spec_files=($(find spec/system/ -type f))

  for spec_file in "${spec_files[@]}"
  do
    bundle exec rspec "$spec_file" --fail-fast
  done
}

delete_bosh_deployment_to_remove_state() {
  bosh -t "$BOSH_TARGET" -n delete deployment "$DEPLOYMENT_NAME"
}

main
